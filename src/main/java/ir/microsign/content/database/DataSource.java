package ir.microsign.content.database;import android.content.Context;import java.util.ArrayList;import java.util.List;import java.util.Locale;import ir.microsign.content.object.Content;import ir.microsign.content.object.Helper;import ir.microsign.contentcore.database.DbHelper;import ir.microsign.contentcore.object.Category;import ir.microsign.contentcore.object.Suggest;import ir.microsign.dbhelper.object.BaseObject;import ir.microsign.utility.Text;/** * Created by Mohammad on 6/25/14. */public class DataSource extends ir.microsign.contentcore.database.DataSource {    Category mRoot = null;//    static DataSource mDataSource=null;    public static DataSource getDataSource(){//        if (mDataSource==null)mDataSource= (DataSource)        return (DataSource) Helper.getHelper().getDataSource();//         mDataSource;    }    public DataSource(Context context) {        super(new DbHelper(context));    }    public Category getCategoryByTag(String tag) {        Category category = new Category();        category.alias = tag;//select(new Category());        return (Category) selectFirst(category);    }    public List<?> getCategories(String where) {        return select(new Category());    }    public List<?> getSubCategories(String parentId) {        Category category = new Category();        category.parent = Text.isEmpty(parentId) ? getRootId() : parentId;        return select(category);    }    public Category getCategory(String id) {        Category category = new Category();        category._id = id;        return (Category) selectFirst(category);    }    public List<?> getUpCategories(Category category) {        return getSubCategories(category.parent);    }    public List<?> getSubCategories(Category category) {        return getSubCategories(category._id);    }    public List<Category> getAllSubCategories(String catId) {        List<Category> temp = (List<Category>) getSubCategories(catId);        List<Category> result = new ArrayList<Category>();        if (temp.size() > 0) result.addAll(temp);        for (Object category : temp) {            List<Category> temp2 = getAllSubCategories(((Category) category)._id);            if (temp2.size() > 0)                result.addAll(temp2);        }        return result;    }    public Category getRoot(String id, boolean reNew) {        if (mRoot != null && !reNew) return mRoot;        Category category = new Category();//		mCategory.title="ROOT";        category._id = id;        BaseObject dbObject = selectFirst(category);        if (dbObject == null) {            mRoot = new Category();            mRoot._id ="";        } else mRoot = (Category) dbObject;        return mRoot;    }    public Category getRoot(String id) {        return getRoot(id, false);    }    public Category getRoot() {        return mRoot;    }    public String getRootId() {        return getRoot()._id;    }    public List<?> search(String txt) {        Category content = new Category();//		content.images="";        List<Category> contents = (List<Category>) select(content);        List<Category> results = new ArrayList<Category>();        for (Category content1 : contents)            if (content1.search(txt)) results.add(content1);        return results;    }    public List<?> getContents(String where) {        return select(new Content(), where);    }    public List<?> getContentsByAlias(String alias) {        Content select = new Content();        select.alias = alias;        return select(select, "alias=" + select.getDbValue("alias"));    }    public List<?> getContents(Category parentCat) {        String q = "SELECT contents.*,bookindexitems.[order] From contents LEFT JOIN bookindexitems ON contents._id=bookindexitems._id WHERE contents.[cat]='" + parentCat._id+"'";            if (!Text.isNullOrEmpty(Content.getHelper().getIndexOrderColumnName()))            q += " ORDER BY ["+Content.getHelper().getIndexOrderColumnName() + (Content.getHelper().getReverseOrder() ? "] DESC" : "] ASC");        return selectByQuery(new Content(), q);//		Content content = new Content();//		content.cat = parentCat._id;//		return select(content);    }    @Override    public List<?> getContentsByCatId(String parentCatId) {        Content content = new Content();        content.cat = parentCatId;        return select(content);    }//    public List<?> getContents(String parentCatId) {////    }    public List<?> getMarkedContents(String parentCatId) {        Content content = new Content();//		content.marked=1;        if (Text.notEmpty(parentCatId))            content.cat = parentCatId;        return select(content, "marked>0" + (Text.notEmpty(parentCatId)? "cat='"+ parentCatId+"'" : ""));    }    public List<Content> getAllSubContents(String catId) {        if (Text.isEmpty(catId)) return (List<Content>) select(new Content());        List<Category> categories = getAllSubCategories(catId);        categories.add(getCategory(catId));        List<Content> contents = new ArrayList<Content>();        for (Category category : categories) {            List<Content> temp = (List<Content>) getContents(category);            if (temp.size() > 0) contents.addAll(temp);        }        return contents;    }    public List<Content> getAllSubContents(String catId, String where) {        if (Text.isEmpty(catId)) return (List<Content>) select(new Content(), where);        List<Category> categories = getAllSubCategories(catId);        categories.add(getCategory(catId));        String where0 = "";        if (categories.size() < 1) return new ArrayList<Content>();        where0 = (categories.size() > 1) ? getInPhrase(categories, "cat", "_id") : " cat=" + categories.get(0).getDbValue("_id");        if (!Text.isNullOrEmpty(where)) where0 += " AND (" + where + ")";        return (List<Content>) select(new Content(), where0);    }//    public List<?> search(String txt, int catId, boolean caseSensitivity, boolean inTitle, boolean inIntro, boolean inFullText) {////        boolean check = (!Text.isNullOrEmpty(txt)) && (inFullText || inIntro || inTitle);//        if (!check) return new ArrayList<Object>();////		Content content=new Content();////		content.images=null;//        String where = "";//        List<String> fields = new ArrayList<>();//        if (inTitle) {//            where += getLikeForSearch("title", txt);//            fields.add("title");//        }//        if (inIntro) {//            where += " OR " + getLikeForSearch("intro", txt);//            fields.add("intro");//        }//        if (inFullText) {//            where += " OR " + getLikeForSearch("full", txt);//            fields.add("full");//        }//        if (where.startsWith(" OR")) where = where.substring(3);//////		return getAllSubContents(catId, where);//        return filterByRegex(getAllSubContents(catId, where), fields,////                Text.getRegex(//                        txt////                        , true)//                , false);//////    }    public Content getFirstHaveImageContent(String catId) {        BaseObject baseObject = selectFirst(new Content(), "cat=\'" + catId + "\' AND (intro LIKE '%<img%' OR full LIKE '%<img%')");        if (baseObject == null) return null;        return (Content) baseObject;    }    public Content getIntroContent(String catId) {        BaseObject baseObject = selectFirst(new Content(), "cat=\'" + catId + "\' AND alias=\'intro\'");        if (baseObject == null) return null;        return (Content) baseObject;    }    public  List<?> getSuggest( String txt,String cat, int limit, int offset) {        if (Text.isNullOrEmpty(txt)) return new ArrayList<>();        StringBuilder sb = new StringBuilder();        if (Text.notEmpty(cat)) sb.append("(");        sb .append("[title] LIKE '%").append(txt).append("%'");        if (Text.notEmpty(cat))sb.append(String.format(Locale.ENGLISH, " AND [cat]=\'%s\')", cat));        return select(new Suggest(),"title","contents",true, sb.toString(), limit, offset,null,true,false);    }    public BaseObject getContentSampleForQuery() {        return new Content();    }    public void autoInsertUpdateContent(List<BaseObject> items) {        autoInsertUpdateById(items);    }}